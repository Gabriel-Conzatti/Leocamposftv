<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pagamento PIX - Sistema de Futev√¥lei</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm" style="background: var(--primary-dark);">
        <div class="container-fluid px-3">
            <a class="navbar-brand" href="{{ url_for('routes.list_classes') }}">Leo Campos | Futev√¥lei</a>
            <div class="ms-auto d-flex align-items-center gap-2">
                <span class="text-white d-none d-sm-inline">Ol√°, {{ session.user_name }}</span>
                <a href="{{ url_for('routes.user_profile') }}" class="text-decoration-none" title="Meu perfil">
                    <div class="rounded-circle bg-white text-primary fw-bold d-flex align-items-center justify-content-center" style="width:36px;height:36px;">{{ session.user_name[:2] }}</div>
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light btn-sm">Sair</a>
            </div>
        </div>
    </nav>
    
    <div class="container" style="padding-top: 96px; padding-bottom: 48px;">
        <div class="row justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="text-center mb-3">
                            <div class="avatar-dot" style="width:56px;height:56px;font-size:1.1rem;">LC</div>
                        </div>
                        <h3 class="text-center mb-2" style="font-family:'Montserrat',sans-serif;">Finalize sua inscri√ß√£o</h3>
                        <p class="text-center text-muted mb-4">Pague via PIX para garantir sua vaga.</p>
                        
                        <div class="alert alert-info">
                            <strong>Aula:</strong> {{ class_obj.title }}<br>
                            <strong>Data:</strong> {{ class_obj.date.strftime('%d/%m/%Y') }} √†s {{ class_obj.time.strftime('%H:%M') }}<br>
                            <strong>Valor:</strong> R$ {{ "%.2f"|format(payment.amount) }}
                        </div>
                        
                        {% if class_obj.status == 'CANCELLED' %}
                            <div class="alert alert-danger">
                                <h4>Aula cancelada</h4>
                                <p class="mb-2">N√£o realize pagamento. Entraremos em contato para estorno quando aplic√°vel.</p>
                                {% if payment.status == 'PAID' %}
                                    <p class="mb-0">Pagamento j√° registrado. Aguarde contato do administrador.</p>
                                {% endif %}
                            </div>
                        {% elif payment.status == 'PAID' %}
                            <div class="alert alert-success text-center">
                                <h4>‚úì Pagamento confirmado!</h4>
                                <p class="mb-0">Sua inscri√ß√£o est√° confirmada. Nos vemos na aula!</p>
                                <a href="{{ url_for('routes.list_classes') }}" class="btn btn-success mt-3">Voltar para aulas</a>
                            </div>
                        {% else %}
                            <div id="payment-status" class="mb-4">
                                <div class="alert alert-warning text-center">
                                    <strong>‚è≥ Aguardando pagamento...</strong>
                                    <p class="mb-0 mt-2">O pagamento ser√° confirmado automaticamente ap√≥s a compensa√ß√£o do PIX.</p>
                                </div>
                            </div>
                            
                            <div class="text-center mb-4">
                                <h5 class="mb-3">Escaneie o QR Code</h5>
                                {% if payment.qr_code_base64 %}
                                    <img src="data:image/png;base64,{{ payment.qr_code_base64 }}" alt="QR Code PIX" class="img-fluid mb-3" style="max-width: 300px;">
                                {% else %}
                                    <div class="alert alert-warning">QR Code n√£o dispon√≠vel</div>
                                {% endif %}
                            </div>
                            
                            <div class="mb-4">
                                <h5>Ou copie o c√≥digo PIX:</h5>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="pix-code" value="{{ payment.pix_payload }}" readonly>
                                    <button class="btn btn-primary" type="button" onclick="copyPixCode(this)">
                                        Copiar c√≥digo
                                    </button>
                                </div>
                                <small class="text-muted">Cole este c√≥digo no seu aplicativo de banco para pagar</small>
                            </div>
                            
                            <div class="alert alert-light border">
                                <strong>Como pagar:</strong>
                                <ol class="mb-0 mt-2">
                                    <li>Abra o app do seu banco</li>
                                    <li>Escolha pagar com PIX</li>
                                    <li>Escaneie o QR Code ou cole o c√≥digo</li>
                                    <li>Confirme o pagamento</li>
                                    <li>Aguarde a confirma√ß√£o autom√°tica (alguns segundos)</li>
                                </ol>
                            </div>
                            
                            <!-- Bot√£o de teste para desenvolvimento -->
                            <div class="text-center mb-3">
                                <button type="button" class="btn btn-primary btn-lg w-100" onclick="refreshPayment()">
                                    üîÑ Atualizar status do pagamento
                                </button>
                                <small class="d-block text-muted mt-2">Usar ap√≥s pagar no app do banco para sincronizar</small>
                            </div>

                            <div class="text-center mb-3">
                                <button type="button" class="btn btn-success btn-lg w-100" onclick="testPaymentApproval()">
                                    ‚úÖ Confirmar pagamento (Teste)
                                </button>
                                <small class="d-block text-muted mt-2">Apenas para testes locais (simula aprova√ß√£o)</small>
                            </div>
                            
                            <div class="text-center mb-3">
                                <a href="{{ url_for('routes.class_detail', class_id=enrollment.class_id) }}" class="btn btn-outline-secondary btn-sm">
                                    üîÑ Gerar novo c√≥digo PIX
                                </a>
                                <small class="d-block text-muted mt-1">Se o c√≥digo expirou ou a internet caiu</small>
                            </div>
                            
                            <div class="alert alert-danger mt-3">
                                <strong>‚ö†Ô∏è IMPORTANTE:</strong><br>
                                Voc√™ s√≥ ser√° <strong>inscrito</strong> ap√≥s confirmar o pagamento!<br>
                                Sem pagamento confirmado, voc√™ <strong>N√ÉO</strong> poder√° participar da aula.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Copiar c√≥digo PIX
        async function copyPixCode(btn) {
            try {
                const pixCode = document.getElementById('pix-code');
                await navigator.clipboard.writeText(pixCode.value);

                const originalText = btn.textContent;
                btn.textContent = '‚úì Copiado!';
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-success');

                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-primary');
                }, 2000);
            } catch (err) {
                alert('N√£o foi poss√≠vel copiar o c√≥digo.');
            }
        }
        
        // Atualizar status real no Mercado Pago
        async function refreshPayment() {
            try {
                const response = await fetch('{{ url_for("routes.payment_refresh", enrollment_id=enrollment.id) }}', { method: 'POST' });
                const data = await response.json();
                if (data.status === 'approved') {
                    alert('Pagamento aprovado! Recarregando...');
                    location.reload();
                } else if (data.status === 'pending') {
                    alert('Pagamento ainda pendente. Aguarde alguns segundos e tente de novo.');
                } else if (data.status === 'rejected') {
                    alert('Pagamento rejeitado/cancelado. Gere um novo c√≥digo.');
                } else {
                    alert('Erro: ' + (data.error || 'n√£o foi poss√≠vel atualizar'));
                }
            } catch (err) {
                alert('Erro ao consultar pagamento: ' + err);
            }
        }

        // Simular aprova√ß√£o de pagamento (para testes)
        async function testPaymentApproval() {
            if (confirm('Deseja simular a aprova√ß√£o deste pagamento?')) {
                try {
                    const response = await fetch('{{ url_for("routes.test_approve_payment", enrollment_id=enrollment.id) }}', {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        alert('‚úì Pagamento aprovado! Recarregando...');
                        location.reload();
                    } else {
                        alert('‚ùå Erro ao aprovar pagamento');
                    }
                } catch (error) {
                    alert('‚ùå Erro: ' + error);
                }
            }
        }
        
        // Verificar status do pagamento a cada 3 segundos
        {% if payment.status != 'PAID' %}
        setInterval(async () => {
            try {
                const response = await fetch('{{ url_for("routes.payment_status", enrollment_id=enrollment.id) }}');
                const data = await response.json();
                
                if (data.paid) {
                    // Pagamento confirmado - recarregar p√°gina
                    location.reload();
                }
            } catch (error) {
                console.error('Erro ao verificar pagamento:', error);
            }
        }, 3000);
        {% endif %}
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
