<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ class_obj.title }} - Sistema de Futev√¥lei</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top shadow-sm" style="background: var(--primary-dark);">
        <div class="container-fluid px-3">
            <a class="navbar-brand" href="{{ url_for('routes.list_classes') }}">Leo Campos | Futev√¥lei</a>
            <div class="ms-auto d-flex align-items-center gap-2">
                <span class="text-white d-none d-sm-inline">Ol√°, {{ session.user_name }}</span>
                <a href="{{ url_for('routes.user_profile') }}" class="text-decoration-none" title="Meu perfil">
                    <div class="rounded-circle bg-white text-primary fw-bold d-flex align-items-center justify-content-center" style="width:36px;height:36px;">{{ session.user_name[:2] }}</div>
                </a>
                <a href="{{ url_for('auth.logout') }}" class="btn btn-outline-light btn-sm">Sair</a>
            </div>
        </div>
    </nav>
    
    <div class="container" style="padding-top: 96px; padding-bottom: 48px;">
        <div class="row">
            <div class="col-md-8 mx-auto">
                <div class="mb-3">
                    <a href="{{ url_for('routes.list_classes') }}" class="btn btn-outline-secondary">‚Üê Voltar</a>
                </div>
                
                {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                        {% for category, message in messages %}
                            <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endfor %}
                    {% endif %}
                {% endwith %}
                
                <div class="card shadow">
                    <div class="card-body p-4">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <div>
                                <p class="text-muted mb-1">Aula</p>
                                <h2 class="card-title mb-0" style="font-family:'Montserrat',sans-serif;">{{ class_obj.title }}</h2>
                            </div>
                            {% if class_obj.status == 'CANCELLED' %}
                                <span class="status-dot text-danger">Cancelada</span>
                            {% else %}
                                <span class="status-dot text-success">Ativa</span>
                            {% endif %}
                        </div>

                        {% if class_obj.status == 'CANCELLED' %}
                            <div class="alert alert-danger">
                                <strong>Aula cancelada.</strong>
                                Entraremos em contato para estorno se voc√™ j√° pagou, conforme a pol√≠tica de hor√°rio.
                            </div>
                        {% endif %}
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2"><strong>üìÖ Data:</strong> {{ class_obj.date.strftime('%d/%m/%Y') }}</li>
                                    <li class="mb-2"><strong>üïê Hor√°rio:</strong> {{ class_obj.time.strftime('%H:%M') }}</li>
                                    <li class="mb-2"><strong>‚è±Ô∏è Dura√ß√£o:</strong> {{ class_obj.duration_minutes }} minutos</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <ul class="list-unstyled">
                                    <li class="mb-2"><strong>üë• Capacidade:</strong> {{ class_obj.capacity }} pessoas</li>
                                    <li class="mb-2"><strong>‚úì Inscritos:</strong> {{ class_obj.get_enrolled_count() }}</li>
                                    <li class="mb-2"><strong>üéØ Vagas restantes:</strong> {{ class_obj.get_available_spots() }}</li>
                                    <li class="mb-2"><strong>üí∞ Valor:</strong> <span class="fs-5 text-success">R$ {{ "%.2f"|format(class_obj.price) }}</span></li>
                                </ul>
                            </div>
                        </div>
                        
                        {% if enrolled_students %}
                            <div class="mb-4">
                                <h5>Quem j√° est√° na aula</h5>
                                <div class="d-flex flex-wrap gap-2 align-items-center">
                                    {% for student in enrolled_students %}
                                        <div class="d-flex align-items-center gap-2 px-3 py-2 rounded-pill" style="background: #f0f4f8; border: 1px solid #e0e6ed;">
                                            <div class="avatar-dot" title="{{ student }}">{{ student[:2] }}</div>
                                            <span class="fw-semibold">{{ student }}</span>
                                        </div>
                                    {% endfor %}
                                    <small class="text-muted">{{ enrolled_students|length }} inscritos</small>
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if user_enrollment %}
                            {% if user_enrollment.status == 'CONFIRMED' %}
                                <div class="alert alert-success">
                                    <strong>‚úì Voc√™ est√° inscrito nesta aula!</strong><br>
                                    Pagamento confirmado. Nos vemos l√°!
                                    <div class="d-flex flex-column flex-sm-row gap-2 mt-2">
                                        <a href="{{ url_for('routes.payment_page', enrollment_id=user_enrollment.id) }}" class="btn btn-sm btn-outline-success">
                                            Ver comprovante
                                        </a>
                                        <form method="POST" action="{{ url_for('routes.cancel_enrollment', enrollment_id=user_enrollment.id) }}">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Deseja cancelar sua inscri√ß√£o? Pagamentos n√£o s√£o estornados automaticamente.')">
                                                Cancelar inscri√ß√£o
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            {% elif user_enrollment.status == 'AWAITING_PAYMENT' %}
                                <div class="alert alert-danger" style="border: 3px solid red; padding: 20px;">
                                    <h5 style="color: red; margin-bottom: 15px;">
                                        <strong>‚ö†Ô∏è PAGAMENTO N√ÉO CONFIRMADO!</strong>
                                    </h5>
                                    <p style="margin: 10px 0;">Voc√™ iniciou uma inscri√ß√£o, mas o pagamento ainda n√£o foi realizado.</p>
                                    <p style="margin: 10px 0;"><strong style="color: red;">Voc√™ N√ÉO est√° inscrito at√© confirmar o pagamento!</strong></p>
                                    <p style="margin: 10px 0; font-size: 14px; color: #666;">Clique no bot√£o abaixo para acessar a p√°gina de pagamento.</p>
                                    
                                    <a href="{{ url_for('routes.payment_page', enrollment_id=user_enrollment.id) }}" class="btn btn-danger btn-lg w-100 mt-3" style="font-weight: bold;">
                                        üî¥ IR PARA P√ÅGINA DE PAGAMENTO
                                    </a>

                                    <form method="POST" action="{{ url_for('routes.cancel_enrollment', enrollment_id=user_enrollment.id) }}" class="mt-3">
                                        <button type="submit" class="btn btn-outline-secondary w-100">
                                            Cancelar inscri√ß√£o
                                        </button>
                                        <small class="d-block text-muted mt-1">Cancela a inscri√ß√£o pendente e libera a vaga</small>
                                    </form>
                                </div>
                            {% else %}
                                <div class="alert alert-warning">
                                    <strong>Status:</strong> {{ user_enrollment.status }}<br>
                                    <a href="{{ url_for('routes.payment_page', enrollment_id=user_enrollment.id) }}" class="btn btn-warning btn-sm mt-2">
                                        Verificar status
                                    </a>
                                </div>
                            {% endif %}
                        {% else %}
                            {% if class_obj.status == 'CANCELLED' %}
                                <div class="alert alert-danger">
                                    Aula cancelada. Entraremos em contato sobre estorno se necess√°rio.
                                </div>
                            {% elif class_obj.is_full() %}
                                <div class="alert alert-danger">
                                    <strong>‚úó Aula lotada</strong><br>
                                    N√£o h√° mais vagas dispon√≠veis.
                                </div>
                            {% else %}
                                <form method="POST" action="{{ url_for('routes.enroll_class', class_id=class_obj.id) }}">
                                    <button type="submit" class="btn btn-primary btn-lg w-100">
                                        Inscrever-se nesta aula
                                    </button>
                                    <small class="text-muted d-block text-center mt-2">
                                        Voc√™ ser√° redirecionado para o pagamento via PIX
                                    </small>
                                </form>
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
